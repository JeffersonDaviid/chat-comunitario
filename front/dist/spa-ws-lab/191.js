"use strict";(self.webpackChunkspa_ws_lab=self.webpackChunkspa_ws_lab||[]).push([[191],{191:(M,d,a)=>{a.r(d),a.d(d,{ChatComponent:()=>C});var c=a(177),l=a(4341),m=a(1626),t=a(4438),g=a(6103),h=a(9494);const p=["scrollContainer"],f=(r,i)=>({"mt-4":r,"mt-0.5":i});function x(r,i){1&r&&(t.j41(0,"div",28)(1,"div",29),t.qSk(),t.j41(2,"svg",30),t.nrm(3,"path",31),t.k0s()(),t.joV(),t.j41(4,"p",32),t.EFF(5,"S\xe9 el primero en escribir en este canal."),t.k0s()())}function y(r,i){if(1&r&&(t.qex(0),t.nrm(1,"img",39),t.bVm()),2&r){const n=t.XpG().$implicit,e=t.XpG();t.R7$(),t.Y8G("src",e.getUserAvatar(n),t.B4B)}}function b(r,i){if(1&r&&(t.qex(0),t.j41(1,"span",40),t.EFF(2),t.nI1(3,"date"),t.k0s(),t.bVm()),2&r){const n=t.XpG().$implicit;t.R7$(2),t.SpI(" ",t.i5U(3,1,null==n.payload?null:n.payload.ts,"HH:mm")," ")}}function _(r,i){if(1&r&&(t.j41(0,"div",41)(1,"span",42),t.EFF(2),t.k0s(),t.j41(3,"span",43),t.EFF(4),t.nI1(5,"date"),t.k0s()()),2&r){const n=t.XpG().$implicit,e=t.XpG();t.R7$(2),t.SpI(" ",e.getUserName(n)," "),t.R7$(2),t.SpI(" ",t.i5U(5,2,null==n.payload?null:n.payload.ts,"shortTime")," ")}}function v(r,i){if(1&r&&(t.j41(0,"div",33)(1,"div",34),t.DNE(2,y,2,1,"ng-container",35)(3,b,4,4,"ng-container",35),t.k0s(),t.j41(4,"div",36),t.DNE(5,_,6,5,"div",37),t.j41(6,"div",38),t.EFF(7),t.k0s()()()),2&r){const n=i.$implicit,e=i.index,s=t.XpG();t.Y8G("ngClass",t.l_i(5,f,!s.isSameUser(e),s.isSameUser(e))),t.R7$(2),t.Y8G("ngIf",!s.isSameUser(e)),t.R7$(),t.Y8G("ngIf",s.isSameUser(e)),t.R7$(2),t.Y8G("ngIf",!s.isSameUser(e)),t.R7$(2),t.SpI(" ",s.renderMessage(n)," ")}}let C=(()=>{class r{constructor(n,e,s){this.route=n,this.ws=e,this.http=s,this.communityId="",this.channelId="",this.cedula="",this.outMsg="",this.messages=[],this.connected=!1,this.shouldScrollToBottom=!0}ngOnInit(){this.communityId=this.route.snapshot.paramMap.get("communityId")||"",this.channelId=this.route.snapshot.paramMap.get("channelId")||"",this.cedula=localStorage.getItem("cedula")||"",this.communityId&&this.cedula&&this.ws.setIdentity({communityId:this.communityId,cedula:this.cedula,channelId:this.channelId}),this.subMsg=this.ws.messages$().subscribe(n=>{const e=n.payload?.channelId;e&&e!==this.channelId||this.extractContent(n)&&(this.messages.push(n),this.shouldScrollToBottom=!0)}),this.subStatus=this.ws.status$().subscribe(n=>this.connected=n),this.communityId&&this.channelId&&this.loadHistory()}loadHistory(){this.http.get(`http://localhost:3000/api/auth/communities/${this.communityId}/channels/${this.channelId}/messages`).subscribe({next:n=>{const s=(n?.messages||[]).map(o=>({type:"chat",payload:{...o,text:o.content,ts:new Date(o.timestamp).getTime(),channelId:this.channelId}}));this.messages=s.concat(this.messages),this.shouldScrollToBottom=!0},error:n=>console.error("Error cargando historial",n)})}ngAfterViewChecked(){this.shouldScrollToBottom&&(this.scrollToBottom(),this.shouldScrollToBottom=!1)}scrollToBottom(){try{this.scrollContainer.nativeElement.scrollTop=this.scrollContainer.nativeElement.scrollHeight}catch{}}send(){this.outMsg.trim()&&(this.ws.sendChannelMessage(this.channelId,this.outMsg.trim()),this.outMsg="",this.shouldScrollToBottom=!0)}ngOnDestroy(){this.subMsg&&this.subMsg.unsubscribe(),this.subStatus&&this.subStatus.unsubscribe()}trackByIndex(n,e){return n}extractContent(n){const e=n.payload;if(!e)return null;let s=null;return"string"==typeof e.text&&e.text?s=e.text:"string"==typeof e.content&&e.content?s=e.content:"string"==typeof e.message&&e.message?s=e.message:e.payload&&"string"==typeof e.payload.text&&(s=e.payload.text),s&&s.startsWith("Conectado a comunidad")?null:s}renderMessage(n){return this.extractContent(n)||""}getUserName(n){const e=n.payload;return e?e.sender?.username?e.sender.username:e.sender?.name?e.sender.name:e.user?.username?e.user.username:e.username?e.username:e.senderId?`Usuario ${e.senderId.toString().slice(-4)}`:e.cedula?`C\xe9dula ${e.cedula.slice(-4)}`:"Usuario":"Sistema"}getUserAvatar(n){const e=n.payload;if(e?.sender?.avatar)return e.sender.avatar;if(e?.user?.avatar)return e.user.avatar;if(e?.avatar)return e.avatar;const s=this.getUserName(n);return`https://ui-avatars.com/api/?name=${encodeURIComponent(s)}&background=random&color=fff&size=128`}isSameUser(n){if(0===n)return!1;const s=this.messages[n-1];return this.getUserName(this.messages[n])===this.getUserName(s)}static{this.\u0275fac=function(e){return new(e||r)(t.rXU(g.nX),t.rXU(h.H),t.rXU(m.Qq))}}static{this.\u0275cmp=t.VBU({type:r,selectors:[["chat"]],viewQuery:function(e,s){if(1&e&&t.GBs(p,5),2&e){let o;t.mGM(o=t.lsd())&&(s.scrollContainer=o.first)}},standalone:!0,features:[t.aNF],decls:41,vars:9,consts:[["scrollContainer",""],[1,"h-full","flex","flex-col","bg-white","font-sans","text-gray-900"],[1,"px-6","py-3","border-b","border-gray-200","flex","items-center","justify-between","bg-white","shadow-sm","z-10"],[1,"flex","items-center","gap-3"],[1,"w-8","h-8","flex","items-center","justify-center","bg-gray-100","rounded","text-gray-500","font-medium","text-lg"],[1,"font-bold","text-gray-800","leading-tight","flex","items-center","gap-2"],[1,"flex","items-center","gap-2","text-xs","text-gray-500","mt-0.5"],[1,"flex","h-2","w-2","relative"],[1,"relative","inline-flex","rounded-full","h-2","w-2",3,"ngClass"],[1,"font-medium"],[1,"text-gray-300"],[1,"truncate"],[1,"flex-1","overflow-y-auto","px-4","py-4","scroll-smooth","custom-scrollbar"],["class","h-full flex flex-col items-center justify-center text-center p-8 text-gray-400",4,"ngIf"],["class","group flex gap-3 px-2 py-1 hover:bg-gray-50 rounded transition-colors relative",3,"ngClass",4,"ngFor","ngForOf","ngForTrackBy"],[1,"p-5","pt-2"],[1,"bg-white","border","border-gray-300","rounded-xl","shadow-sm","focus-within:ring-1","focus-within:ring-gray-400","focus-within:border-gray-400","transition-all","relative",3,"submit"],[1,"flex","items-center","gap-1","px-2","py-1.5","bg-gray-50","rounded-t-xl","border-b","border-gray-100"],["type","button",1,"p-1","hover:bg-gray-200","rounded","text-gray-500","font-bold","text-xs","w-6","h-6"],["type","button",1,"p-1","hover:bg-gray-200","rounded","text-gray-500","italic","text-xs","w-6","h-6"],["type","button",1,"p-1","hover:bg-gray-200","rounded","text-gray-500","line-through","text-xs","w-6","h-6"],["name","outMsg","autocomplete","off","placeholder","Enviar un mensaje a #general...",1,"w-full","p-3","bg-transparent","border-none","outline-none","text-[15px]","placeholder-gray-400",3,"ngModelChange","ngModel"],[1,"flex","justify-end","items-center","px-2","pb-2","pt-1"],["type","submit",1,"px-3","py-1.5","rounded","transition-colors","flex","items-center","gap-2","text-sm","font-medium",3,"disabled","ngClass"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-3","h-3","transform","rotate-90"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 19l9 2-9-18-9 18 9-2zm0 0v-8"],[1,"text-center","mt-2"],[1,"text-[10px]","text-gray-400"],[1,"h-full","flex","flex-col","items-center","justify-center","text-center","p-8","text-gray-400"],[1,"bg-gray-50","p-4","rounded-full","mb-3"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-8","h-8","text-gray-300"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"],[1,"text-sm"],[1,"group","flex","gap-3","px-2","py-1","hover:bg-gray-50","rounded","transition-colors","relative",3,"ngClass"],[1,"w-9","flex-shrink-0","flex","flex-col","items-end"],[4,"ngIf"],[1,"flex-1","min-w-0"],["class","flex items-baseline gap-2",4,"ngIf"],[1,"text-[15px]","text-gray-800","leading-relaxed","whitespace-pre-wrap","break-words"],["alt","Avatar",1,"w-9","h-9","rounded","bg-gray-200","object-cover","shadow-sm",3,"src"],[1,"text-[10px]","text-gray-400","opacity-0","group-hover:opacity-100","transition-opacity","pr-1","pt-1"],[1,"flex","items-baseline","gap-2"],[1,"font-bold","text-[15px]","text-gray-900","cursor-pointer","hover:underline"],[1,"text-xs","text-gray-400"]],template:function(e,s){if(1&e){const o=t.RV6();t.j41(0,"div",1)(1,"div",2)(2,"div",3)(3,"div",4),t.EFF(4,"#"),t.k0s(),t.j41(5,"div")(6,"h2",5),t.EFF(7," Canal General "),t.k0s(),t.j41(8,"div",6)(9,"span",7),t.nrm(10,"span",8),t.k0s(),t.j41(11,"span",9),t.EFF(12),t.k0s(),t.j41(13,"span",10),t.EFF(14,"|"),t.k0s(),t.j41(15,"span",11),t.EFF(16),t.k0s()()()()(),t.j41(17,"div",12,0),t.DNE(19,x,6,0,"div",13)(20,v,8,8,"div",14),t.k0s(),t.j41(21,"div",15)(22,"form",16),t.bIt("submit",function(){return t.eBV(o),t.Njj(s.send())}),t.j41(23,"div",17)(24,"button",18),t.EFF(25,"B"),t.k0s(),t.j41(26,"button",19),t.EFF(27,"I"),t.k0s(),t.j41(28,"button",20),t.EFF(29,"S"),t.k0s()(),t.j41(30,"input",21),t.mxI("ngModelChange",function(u){return t.eBV(o),t.DH7(s.outMsg,u)||(s.outMsg=u),t.Njj(u)}),t.k0s(),t.j41(31,"div",22)(32,"button",23),t.EFF(33," Enviar "),t.qSk(),t.j41(34,"svg",24),t.nrm(35,"path",25),t.k0s()()()(),t.joV(),t.j41(36,"div",26)(37,"p",27)(38,"strong"),t.EFF(39,"Tip:"),t.k0s(),t.EFF(40," Pulsa Enter para enviar"),t.k0s()()()()}2&e&&(t.R7$(10),t.Y8G("ngClass",s.connected?"bg-green-500":"bg-red-500"),t.R7$(2),t.JRh(s.connected?"Online":"Offline"),t.R7$(4),t.SpI("Comunidad: ",s.communityId,""),t.R7$(3),t.Y8G("ngIf",0===s.messages.length),t.R7$(),t.Y8G("ngForOf",s.messages)("ngForTrackBy",s.trackByIndex),t.R7$(10),t.R50("ngModel",s.outMsg),t.R7$(2),t.Y8G("disabled",!s.outMsg.trim())("ngClass",s.outMsg.trim()?"bg-green-700 text-white hover:bg-green-800":"bg-gray-100 text-gray-400"))},dependencies:[c.MD,c.YU,c.Sq,c.bT,c.vh,l.YN,l.qT,l.me,l.BC,l.cb,l.vS,l.cV,m.q1],styles:[".custom-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar{width:8px}.custom-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:transparent}.custom-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background-color:#0000001a;border-radius:4px}.custom-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar-thumb:hover{background-color:#0003}input[_ngcontent-%COMP%]:focus{box-shadow:none}"]})}}return r})()}}]);